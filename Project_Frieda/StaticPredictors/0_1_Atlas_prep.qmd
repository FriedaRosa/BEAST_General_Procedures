---
title: "Atlas Data Prep"
author: "Friederike WÃ¶lke"
format: html
editor: visual
---

## Libraries

```{r, message = F}

rm(list=ls())
library(sf)
sf_use_s2(FALSE) # switch spherical geometry off
library(dplyr)
library(AICcmodavg)
library(tidyr)
library(sparta)
library(ggplot2)
library(ggpubr)
library(rstatix)
```

## Data Paths

```{r}
#| warning: false
#| message: false
#| label: Variables

source_atlas <- c("c:/Users/wolke/OneDrive - CZU v Praze/Datasets/Processed/Atlases/Replicated/")
source_predictors <- c("c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/PhD_Projects/StaticPredictors/Data/")
source_Git <- c("c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/GitHub/BEAST_General_Procedures/Project_Frieda/StaticPredictors/")

# folder path to atlas data
source_paths <- c(paste0(source_atlas, "Birds_Atlas_Czechia/"), 
                  paste0(source_atlas, "Birds_Atlas_New_York/"), 
                  paste0(source_atlas, "Birds_atlas_Japan/"), 
                  paste0(source_atlas, "Birds_atlas_EBBA/"))

# folder path to output folder
out_path <- c(paste0(source_Git, "out/"))

# create path to read in data and grids from variables
data_paths <- c(paste0(source_paths[1],"Birds_Atlas_Czechia_beast_data.rds"), 
                paste0(source_paths[2], "Birds_Atlas_New_York_beast_data.rds"), 
                paste0(source_paths[3], "Birds_atlas_Japan_beast_data.rds"),
                paste0(source_paths[4], "Birds_atlas_EBBA_beast_data.rds"))

grid_paths <- c(paste0(source_paths[1],"Birds_Atlas_Czechia_grid.gpkg"), 
                paste0(source_paths[2], "Birds_Atlas_New_York_grid.gpkg"), 
                paste0(source_paths[3], "Birds_atlas_Japan_grid.gpkg"),
                paste0(source_paths[4], "Birds_atlas_EBBA_grid.gpkg"))

atlas_names <- c("Birds_Atlas_Czechia", "Birds_Atlas_New_York","Birds_atlas_Japan", "Birds_atlas_EBBA")
# Define the desired order of factor levels
desired_levels <- factor(c("1", "2","4", "8", "16", "32", "64", "128"), ordered = T,  levels = c("1", "2","4", "8", "16", "32", "64", "128")) 


```

## Read & Process Data

```{r}



# Species data  =====================
presence_data <- list()
for (i in seq_along(data_paths)){
  pres_dat <- readRDS(data_paths[i])
  sy <- sort(unique(pres_dat$start_year))
  
## Add time-period column 
  pres_dat2 <- pres_dat %>% 
    mutate(tp = ifelse(start_year == sy[1], 1, 2)) %>% 
    reorder_levels( cell_grouping, order=desired_levels)
  
  ## Filter for cells that have been sampled twice ============== (!!)
  pres_dat3 <- pres_dat2 %>% ungroup() %>% 
    group_by(cell_label, cell_grouping) %>%
    mutate(num_periods = n_distinct(tp)) %>%
    mutate(repeated = ifelse(num_periods == 2, 1, 0)) %>%
    filter(repeated == 1)
  
  ## Filter for species that have change data (sp that occur in both time periods)
  common_species <- pres_dat3 %>%
    group_by(verbatim_name) %>%
    summarise(num_periods = n_distinct(tp)) %>%
    filter(num_periods == 2) %>%
    pull(verbatim_name)
  
  pres_dat4 <- pres_dat3 %>% filter(verbatim_name %in% common_species)

  presence_data[[i]] <- pres_dat4
}

# remove tp3 from CZ data for easier handling of all datasets
presence_data[[1]] <- presence_data[[1]] %>% 
  filter(start_year != 2014) 

# Merge list together
presence_data_df <- plyr::rbind.fill(presence_data, fill=T)
presence_data2 <- presence_data_df

# Vetor with atlas names
atlas_names <- unique(presence_data2$dataset)




### Save it ================================
# saveRDS(presence_data2, paste0(out_path, "presence_data.rds"))

# clear space:
rm(presence_data, presence_data_df, pres_dat, pres_dat2, pres_dat3, pres_dat4, common_species, sy)
#### =======================================





## grid data =====================

# make list with names of layers so we can read them in below
layers_list <- list()

## save names of layers from file (needed to read them in):
for (i in seq_along(grid_paths)){
  layers <- st_layers(grid_paths[i])$name
  layers_list[[i]] <- layers
}



grid_list2 <- list()
for (a in seq_along(grid_paths)) {
    grid_list <- sapply(layers_list[[a]], function(i) {
      
      st_read(grid_paths[[a]], paste(i), quiet = TRUE) %>% 
        st_transform(crs = 4326) %>% reorder_levels( cell_grouping, order=desired_levels)
      
      }, simplify = FALSE)
    grid_list2[[a]] <- grid_list
    
    }



 # clear space
rm(grid_list, a, layers, layers_list)

```

## Calculate occupancy

```{r, calculate occupancy short version}

pres_dat_full1 <- list()
pres_dat_full3 <- list()

for (n_atlas in seq_along(atlas_names)){
  atlas_name <- atlas_names[n_atlas] # set variable for current run of the loop
  atlas <- grid_list2[[n_atlas]]# subset list of atlases to one
  
  for (grain in seq_along(atlas)){
    # set some variables for current run of the loop
    grain_a <- names(atlas)[grain]
    grain_d <- as.numeric(gsub("\\D", "", grain_a)) # "\\D" = remove all non-numbers
    
    # subset atlas to one grain
    atlas_1scale <- atlas[[grain]] %>% 
      select(cell_grouping, cell_label, area, cell_long, cell_lat) %>%
      st_drop_geometry()
    
    # Calculate total sampled area per time period:
    atlas_1scale <- atlas_1scale %>% 
      group_by(cell_grouping) %>%
      mutate(Total_area = sum(atlas_1scale$area))
    
    # Calculate total number of sampled cells per time period:
    Total_Ncells <- atlas_1scale %>%
      group_by(cell_grouping) %>%
      mutate(Total_Ncells = length(unique(cell_label))) %>%
      pull(Total_Ncells) %>%
      unique()
    
    atlas_1scale$Total_Ncells <- Total_Ncells
    map_atlas_1scale <- atlas_1scale
    
    # subset the presence/absence data to the current spatial grain:
    pres_data_1atlas <- presence_data2 %>% 
      filter(dataset == atlas_name) %>%
      filter(cell_grouping == grain_d) %>%
      select(dataset, tp, verbatim_name, samp_effort_type, effort, cell_label, cell_grouping, repeated)
  
    # Merge sampled and unsampled cells for calculations:
    pres_data_full_1atlas <- left_join(map_atlas_1scale, pres_data_1atlas)
    pres_data_full_1atlas %>% filter(!is.na(verbatim_name))
    pres_data_full_1atlas$dataset <- atlas_names[n_atlas]
    pres_dat_full1[[grain]] <- pres_data_full_1atlas %>% unique()
    
  }
  
  pres_dat_full2 <- plyr::rbind.fill(pres_dat_full1, fill=T)
  pres_dat_full3[[n_atlas]] <- pres_dat_full2
  
}

pres_dat_full4 <- plyr::rbind.fill(pres_dat_full3, fill=T)

pres_dat_final <- pres_dat_full4 %>%  
  mutate(cell_grouping = factor(cell_grouping, 
                                levels = desired_levels)) %>% 
  filter(!is.na(verbatim_name))


### =============================================== ###
rm(pres_dat_full1, pres_dat_full2, pres_dat_full3, pres_dat_full4, pres_data_1atlas, pres_data_full_1atlas, map_atlas_1scale)
### =============================================== ###


occ_data <- pres_dat_final %>%
  ungroup() %>%
  group_by(dataset, tp, cell_grouping, verbatim_name) %>% distinct() %>%
# Calculate Occupancy:
  mutate(occupancy_area = sum(area),
         mean_area = mean(area)) %>%
  mutate(occupancy_Ncells = n_distinct(cell_label)) %>%
# Calculate AOO:
  mutate(AOO = occupancy_Ncells * mean(area)) %>%
# Calculate relative Occupancy:
  mutate(relative_occupancy_area = occupancy_area/Total_area) %>%
  mutate(relative_occupancy_Ncells = occupancy_Ncells/Total_Ncells) %>% ungroup() %>%
  group_by(dataset, tp, cell_grouping) %>%
  mutate(total_SR_atlas = n_distinct(verbatim_name)) %>%
# Remove duplicated rows:
  distinct() 

occ_data$cell_grouping2 <- as.numeric(as.character(occ_data$cell_grouping))
# occ_data %>% filter_all(any_vars(is.na(.))) ## NAs in the effort columns for some atlases

# create scale column as a fraction of the full country:
occ_data_final <- occ_data %>% 
  ungroup() %>%
  group_by(dataset) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "1", 1/64, NA)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "2", 1/32, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "4", 1/16, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "8", 1/8, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "16", 1/4, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "32", 1/2, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[1]) & cell_grouping == "64", 1, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "1", 1/128, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "2", 1/16, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "4", 1/32, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "8", 1/16, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "16", 1/8, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "32", 1/4, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "64", 1/2, scale)) %>%
  mutate(scale = ifelse(dataset %in% c(atlas_names[2:4]) & cell_grouping == "128", 1, scale))

# occ_data_final %>% filter_all(any_vars(is.na(.)))


### =============================================== ###
rm(occ_data)
### =============================================== ###

# save reduced version of this to file:

species_data <- occ_data_final %>% 
  select(dataset, tp, cell_grouping, scale, verbatim_name, Total_area, Total_Ncells, 
         occupancy_area, occupancy_Ncells, AOO, relative_occupancy_area, relative_occupancy_Ncells, mean_area, total_SR_atlas) %>%
  distinct() 

table(species_data$dataset)

species_data %>% filter(AOO == 0) #none!

species_data %>% write.csv(paste0(out_path, "Occupancy_table.csv"))

```

```{r}
plot(x = log(occ_data_final$area), y = log(occ_data_final$AOO))
plot(x = log(occ_data_final$scale), y = log(occ_data_final$AOO))
```

## Occupancy-Area Relationship

A consideration:

-   when saturated scales are excluded (i.e., scales for each species where: relative occupancy = 1), there are not enough scales left for some species (in CZ) to calculate the OAR: many of them saturate quickly.

    -   original scale: 4 (tp1), 5 (tp2)

    -   2nd scale: 21 (tp1), 24 (tp2)

    -   3rd scale: 32 (tp1), 66 (tp2)\
        \
        --\> by scale 3, 57 (tp1) and 95 (tp2) species are saturated in CZ

-   New York:

    -   3rd scale: 9 (tp1), 1 (tp2)

-   Japan

    -   3rd scale: 1 (tp2)

```{r, Saturated Species stats}

x <- species_data %>% 
  filter(relative_occupancy_Ncells == 1) %>% 
  distinct() %>%
  group_by(dataset, cell_grouping, tp) %>%
  summarise(N_sp = n_distinct(verbatim_name),
            mean_area = mean_area,
            mean_Ncells = mean(occupancy_Ncells),
            total_SR_atlas = total_SR_atlas) %>%
  mutate(proportion_perc = round(((N_sp/total_SR_atlas)*100),0)) %>% distinct() # check saturated occupancies

x

plot(log(x$mean_area), log(x$AOO), "l")
plot(x$mean_area, x$proportion_perc)

plot(log(x$N_sp), log(x$mean_area))
```

```{r OAR}
dd <- species_data %>%
  #filter(relative_occupancy_Ncells < 1) %>% # exclude saturated scales
  unique() %>%
  filter_at(vars(c(
      cell_grouping, scale,
      AOO, occupancy_Ncells,
      relative_occupancy_Ncells, mean_area)), any_vars(!is.na(.)))

## Variables:
atlas_names <- unique(dd$dataset)
period <- c(1,2)
OAR_list_sp <- list()
OAR_list_sp_tp <- list()
OAR_list_sp_tp_atlas <- list()

## Loop:
for (n_atlas in seq_along(atlas_names)){
  atlas_name <- atlas_names[n_atlas]
  atlas <- dd %>% filter(dataset == atlas_name)
  for (time in seq_along(period)){
    period_nr <- period[time]
    atlas_1time <- atlas %>% filter(tp == period_nr) 
    sp <- unique(atlas_1time$verbatim_name)
    for(spec in seq_along(sp)){
      species <- sp[spec]
      model_df <- atlas_1time %>% filter(verbatim_name == species) %>% distinct()
      
      
      #### Compare different OAR calculations:
      # I. AOO ~ scale
      OAR_I <- lm(log(AOO) ~ log(scale), data = model_df)
      # II. AOO ~ area
      OAR_II <- lm(log(AOO) ~ log(mean_area), data = model_df)
      # III. relative_occ ~ scale
      OAR_III <- lm(log(relative_occupancy_Ncells) ~ log(scale), data = model_df)
      # IIII. relative_occ ~ area
      OAR_IIII <- lm(log(relative_occupancy_Ncells) ~ log(mean_area), data = model_df)
      
      OAR_df <- data.frame(
        verbatim_name = species,
        dataset = atlas_name,
        tp = period_nr, 
        m_AOO_s = OAR_I$coefficients[2],
        b_AOO_s = OAR_I$coefficients[1],
        m_relOcc_s = OAR_III$coefficients[2], 
        b_relOcc_s = OAR_III$coefficients[1],
        m_AOO_a = OAR_II$coefficients[2],
        b_AOO_a = OAR_II$coefficients[1],
        m_relOcc_a = OAR_IIII$coefficients[2], 
        b_relOcc_a = OAR_IIII$coefficients[1])
      
      OAR_df$D_AOO_s <- -2*OAR_df$m_AOO_s+2
      OAR_df$D_relOcc_s <- -2*OAR_df$m_relOcc_s+2      
      OAR_df$D_AOO_a <- -2*OAR_df$m_AOO_a+2
      OAR_df$D_relOcc_a <- -2*OAR_df$m_relOcc_a+2
      OAR_df$dataset <- as.factor(OAR_df$dataset)
      

      OAR_list_sp[[spec]] <- OAR_df
      
    }
    
    OAR_df_sp <- plyr::rbind.fill(OAR_list_sp, fill = T)
    OAR_list_sp_tp[[time]] <- OAR_df_sp
     
  }
  OAR_df_sp_tp <- plyr::rbind.fill(OAR_list_sp_tp, fill = T)   
  OAR_list_sp_tp_atlas[[n_atlas]] <- OAR_df_sp_tp
}
    
OAR_final <- plyr::rbind.fill(OAR_list_sp_tp_atlas, fill = T) %>% distinct()

OAR_final %>% filter_all(any_vars(is.na(.))) # None !#


species_data_new <- merge(species_data, 
                          OAR_final, 
                          by=c(intersect(names(species_data), names(OAR_final))), all = T) %>% distinct()


species_data_new %>% filter(is.na(m_AOO_s)) %>% pull(verbatim_name) %>% unique() 
species_data_new %>% filter(is.na(m_AOO_s)) %>% pull(dataset) %>% unique() 

# NAs where we did not have enough scales to calculate the OAR after removing the saturated scales. This is only the case for Czech Republic

### =============================================== ###
rm(dd, OAR_list_sp_tp_atlas, OAR_list_sp_tp, OAR_df_sp_tp, OAR_list_sp, OAR_df_sp, OAR_df, OAR_I, OAR_II, OAR_III, OAR_IIII, sp, atlas_1time, model_df )
### =============================================== ###

```

## Telfer Index of change (not static)

```{r, telfer calculation}

# Telfer:
telfer_res <- list()
for (i in seq_along(atlas_names)){
  df <- pres_dat_final %>% filter(dataset == atlas_names[i]) %>% distinct()
  telfer <- sparta::telfer(taxa = df$verbatim_name,
                         site = df$cell_label,
                         time_period = df$tp,
                         minSite = 2)
telfer$dataset <- atlas_names[i]
telfer_res[[i]] <- telfer
  
}

telfer_res_df <- plyr::rbind.fill(telfer_res, fill = T) %>% distinct() %>%
  select(taxa, Telfer_1_2, dataset) %>% 
  rename(verbatim_name = taxa)%>%
  reorder_levels(dataset, order = atlas_names)


species_data_new2 <- left_join(species_data_new, telfer_res_df)

```

```{r, compare different OAR metrics}
range(species_data_new2$D_AOO_a)
range(species_data_new2$D_AOO_s)
range(species_data_new2$D_relOcc_a)
range(species_data_new2$D_relOcc_s)

### When saturated species are excluded =========
# > range(species_data_new2$D_AOO_a)
# [1] -0.2108926  1.9904707
# > range(species_data_new2$D_AOO_s)
# [1] -3.529467  1.981414
# > range(species_data_new2$D_relOcc_a)
# [1] -4.610428  2.078933
# > range(species_data_new2$D_relOcc_s)
# [1] -1.826191  2.149169


### When saturated species are included ========
# > range(species_data_new2$D_AOO_a)
# [1] -0.09442033  1.99667921
# > range(species_data_new2$D_AOO_s)
# [1] -2.751418  1.993737
# > range(species_data_new2$D_relOcc_a)
# [1] -0.1061045  2.0789326
# > range(species_data_new2$D_relOcc_s)
# [1] -1.773235  2.149169

library(ggcorrplot)
cor_df <- species_data_new2[-c(1:2,4)]
cor(cor_df, use = "pairwise.complete.obs")


p.mat <- model.matrix(~0+., data=cor_df) %>% 
  ggcorrplot::cor_pmat()

model.matrix(~0+., data= species_data_new2[-c(1:2,4)]) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot( lab=TRUE, lab_size=2, hc.order=T, insig ="blank",p.mat = p.mat)


### =============================================== ###
rm(telfer, telfer_res, species_data_new, df)
### =============================================== ###

```

```{r, telfer ggplots}

library(ggplot2)
## Plot
ggplot(data = telfer_res_df) +
  geom_histogram(aes(x = Telfer_1_2), bins = 50, 
                 bg = "lightgrey", col = "darkgrey")+
  theme_classic() +
  facet_wrap(dataset~.)


ggplot(data = telfer_res_df %>% filter(dataset == "Birds_atlas_EBBA")) +
  geom_histogram(aes(x = Telfer_1_2), bins = 100, 
                 bg = "lightgrey", col = "darkgrey")+
  theme_classic()
 
p1 <- ggplot(data = telfer_res_df)+
  geom_boxplot(aes(y = Telfer_1_2, x = dataset), outlier.colour = "red")+
  theme_classic()+
  labs(title = "Telfer index of relative Change")


# Welch One way ANOVA test
res.aov2 <- telfer_res_df %>% welch_anova_test(Telfer_1_2 ~ dataset)
# Pairwise comparisons (Games-Howell)
pwc2 <- telfer_res_df %>% games_howell_test(Telfer_1_2 ~ dataset)
# Visualization: box plots with p-values
pwc2 <- pwc2 %>% add_xy_position(x = "dataset", step.increase = 1)
plot1 <- ggviolin(telfer_res_df, x = "dataset", y = "Telfer_1_2") +
  stat_pvalue_manual(pwc2, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(res.aov2, detailed = TRUE),
    caption = get_pwc_label(pwc2)
    )
```

### Make wide-format

```{r, make wide format}

# Re-formating the data.. there is probably a smoother way to do it..
species_data_wide1 <- species_data_new2 %>% 
  select(verbatim_name, tp, cell_grouping, 
         D_AOO_s, m_AOO_s, 
         D_AOO_a, m_AOO_a,
         D_relOcc_s, m_relOcc_s,
         D_relOcc_a, D_relOcc_a,
         AOO, 
         Total_Ncells, mean_area,
          occupancy_Ncells, 
         relative_occupancy_Ncells, dataset) %>% 
  group_by(dataset, verbatim_name, tp) %>% 
  distinct() %>% 
  filter(tp == 1) %>% 
  setNames(paste0('tp1_', names(.))) %>% 
  ungroup() %>%
  select(-c(tp1_tp)) %>%
  rename(verbatim_name = tp1_verbatim_name,
         cell_grouping = tp1_cell_grouping, 
         dataset = tp1_dataset)

species_data_wide2 <- species_data_new2 %>% 
  select(verbatim_name, tp, cell_grouping, 
         D_AOO_s, m_AOO_s, 
         D_AOO_a, m_AOO_a,
         D_relOcc_s, m_relOcc_s,
         D_relOcc_a, D_relOcc_a,
         AOO, 
         Total_Ncells, mean_area,
          occupancy_Ncells, 
         relative_occupancy_Ncells, dataset) %>% 
  group_by(dataset, verbatim_name, tp) %>% 
  distinct() %>% 
  filter(tp == 2) %>% 
  setNames(paste0('tp2_', names(.))) %>% 
  ungroup() %>%
  select(-c(tp2_tp)) %>%
  rename(verbatim_name = tp2_verbatim_name,
         cell_grouping = tp2_cell_grouping, 
         dataset = tp2_dataset)

# merge back together:
temp <- merge(species_data_wide1, species_data_wide2, 
              by=intersect(names(species_data_wide1), names(species_data_wide2)), all = T)
names_v <- names(temp)[-(1:3)] # remove verbatim_name, cell_grouping and dataset columns

# Transform to wide format by cell_grouping
species_data_wide <- temp %>% 
  pivot_wider(names_from = cell_grouping,
              values_from = all_of(names_v)) %>% unique()

### =============================================== ###
rm(species_data_wide1, species_data_wide2, temp, names_v)
### =============================================== ###


```

## Log Ratio (Temporal Change = Response)

```{r, temporal change}
# Calculate log-Ratio of AOO (Temporal change)
log_ratio_data <- species_data_wide %>% 
  mutate(log_R2_1 = log(tp2_AOO_1/tp1_AOO_1)) %>%
  select(dataset, verbatim_name, log_R2_1)

species_data_bigtable <- merge(species_data_new2, log_ratio_data, by=c("verbatim_name", "dataset"),all = T)
species_data_bigtable %>% write.csv(file=paste0(out_path, "Big_table_CZ_JP_NY.csv"))


species_data_bigtable %>% filter_all(any_vars(is.na(.))) %>% 
  select(dataset, tp, verbatim_name) %>% unique() ### There is a problem here !


species_data_bigtable %>% 
  group_by(dataset, tp, cell_grouping) %>% 
  select(verbatim_name, dataset, tp, cell_grouping, 
         log_R2_1, Telfer_1_2,
         AOO, relative_occupancy_Ncells, 
        D_AOO_s, m_AOO_s, 
         D_AOO_a, m_AOO_a,
         D_relOcc_s, m_relOcc_s,
         D_relOcc_a, D_relOcc_a, mean_area) %>%
  rstatix::get_summary_stats(type = "mean_sd")



Change_Data <- species_data_bigtable %>% 
  filter(!is.na(log_R2_1)) %>% 
  select(verbatim_name, dataset, log_R2_1) %>% 
  distinct() %>% 
  na.omit() %>%
  reorder_levels(dataset, order = atlas_names)


Change_Data %>% 
  write.csv(paste0(out_path, "Change_Data.csv"))

Change_Data %>% 
  group_by(dataset) %>% 
  summarise(N_sp = n(),
            meanChange = mean(log_R2_1),
            sdChange = sd(log_R2_1),
            medianChange = median(log_R2_1))


species_data_bigtable %>% 
  filter(!is.na(Telfer_1_2) & cell_grouping == 1) %>% 
  select(verbatim_name, dataset, Telfer_1_2) %>% 
  distinct() %>% 
  na.omit() %>% 
  group_by(dataset) %>% 
  summarise(N_sp = n(),
            meanChange = mean(Telfer_1_2),
            sdChange = sd(Telfer_1_2),
            medianChange = median(Telfer_1_2))

### =============================================== ###
rm(species_data_new2, log_ratio_data)
### =============================================== ###

```

```{r, fig.height = 10}
  
p2 <- ggplot(data = Change_Data)+
  geom_boxplot(aes(y = log_R2_1, x = dataset), outlier.colour = "red")+
  theme_classic()+
  labs(title = "log Ratio")
gridExtra::grid.arrange(p1, p2)


# Welch One way ANOVA test
res.aov2 <- Change_Data %>% welch_anova_test(log_R2_1 ~ dataset)
# Pairwise comparisons (Games-Howell)
pwc2 <- Change_Data %>% games_howell_test(log_R2_1 ~ dataset)
# Visualization: box plots with p-values
pwc2 <- pwc2 %>% add_xy_position(x = "dataset", step.increase = 1)
plot2 <- ggviolin(Change_Data, x = "dataset", y = "log_R2_1") +
  stat_pvalue_manual(pwc2, hide.ns = TRUE) +
  labs(
    subtitle = get_test_label(res.aov2, detailed = TRUE),
    caption = get_pwc_label(pwc2)
    )

gridExtra::grid.arrange(plot1, plot2)
```

## Negative D?

```{r}
x <- species_data_bigtable %>% filter(D_AOO_s < 0 & relative_occupancy_area < 1)
sp <- unique(x$verbatim_name)
length(sp) # 60 species from CZ have negative D

x %>% group_by(dataset, tp) %>% rstatix::get_summary_stats(type="common")


# Comparison plot
species_data_bigtable %>% filter(D_AOO_s > 0 & relative_occupancy_area < 1) %>%
  ggplot(aes(x = log(scale), y=log(AOO), col = tp, alpha = 0.5))+
    geom_point()+
    geom_line(aes(group = factor(verbatim_name)))+
    theme_classic()+
    facet_wrap(dataset~.)+
    labs(title = "D > 0")+
    viridis::scale_color_viridis(discrete = F)+
    theme(legend.position = "none")

species_data_bigtable %>% filter(D_AOO_s < 0 & relative_occupancy_area < 1) %>%
  ggplot(aes(x = log(scale), y=log(AOO), col = tp, alpha = 0.5))+
    geom_point()+
    geom_line(aes(group = factor(verbatim_name)))+
    theme_classic()+
    facet_wrap(dataset~.)+
    labs(title = "D < 0")+
    viridis::scale_color_viridis(discrete = F)+
    theme(legend.position = "none")



x_list <- list()
for (i in seq_along(sp)) {
  model_df <- x %>% filter(verbatim_name == sp[i]) %>% unique()
  m_lin <- lm(log(AOO) ~ log(scale), data = model_df)
  dd <- data.frame(
      verbatim_name = sp[i],
      m_AOO = m_lin$coefficients[2],
      b_AOO = m_lin$coefficients[1],
      r2_AOO = summary(m_lin)$r.squared)
  dd$D_AOO <- -2*dd$m_AOO+2
  dd 
  x_list[[i]] <- dd
 }

```

## Correlation matrix

```{r}
library(ggcorrplot)
cor_df <- species_data_bigtable %>% 
  select("tp", "scale", 
         "AOO", "relative_occupancy_Ncells", 
        "D_AOO_s", "m_AOO_s", 
         "D_AOO_a", "m_AOO_a",
         "D_relOcc_s", "m_relOcc_s",
         "D_relOcc_a", "D_relOcc_a", "mean_area",
         "Telfer_1_2", "log_R2_1", "dataset")

p.mat <-  model.matrix(~0+., data=cor_df) %>% ggcorrplot::cor_pmat()

model.matrix(~0+., data=cor_df) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot( lab=TRUE, lab_size=2, hc.order=T, insig ="blank",p.mat = p.mat)


```

```{r}
m1 <- lm(log_R2_1 ~ D_AOO_s, data = species_data_bigtable, na.action = na.omit)
summary(m1)
m2 <- lm(Telfer_1_2 ~ D_AOO_s, data = species_data_bigtable, na.action = na.omit)
summary(m2)

```

## Plot: Temporal Change \~ D

```{r}
# Plots =================================================================== #
## 1. Change between tp1 and 2 ~ D from tp1
p1 <- species_data_bigtable %>% filter(tp == 1) %>%
  ggplot(aes(y = log_R2_1, x = D_AOO_s))+
  geom_point()+
  ylab(expression("log"~ frac("tp2_AOO_cell1grid", "tp1_AOO_cell1grid")))+
  xlab("tp1_D")+
 #geom_smooth(method = "lm", formula = y ~ x, se = T, alpha = 0.5)+
  geom_smooth(alpha = 0.5)+
  theme_classic()+
  labs(title = "Prediction of future change",
       subtitle = "Log Ratio between AOO from time period 1 and 2 ~ D from time period 1 ")+
    geom_hline(yintercept = 0, col = "red")+
  facet_wrap(dataset~.)




p2 <- species_data_bigtable %>% filter(tp == 2) %>%
  ggplot(aes(y = log_R2_1, x = D_AOO_s))+
  geom_point()+
  ylab(expression("log"~ frac("tp2_AOO_cell1grid", "tp1_AOO_cell1grid")))+
  xlab("tp2_D")+
 geom_smooth(method = "lm", formula = y ~ x, se = T, alpha = 0.5)+
  theme_classic()+
  labs(title = "Prediction of past change",
       subtitle = "Log Ratio between AOO from time period 1 and 2 ~ D from time period 2 ")+
    geom_hline(yintercept = 0, col = "red")+
  facet_wrap(dataset~.)


gridExtra::grid.arrange(p1,p2, nrow = 1, ncol = 2)
```

# Predictors

```{r}

# Make dataframe with predictors ======================
names(species_data_bigtable)

predictors_df <- species_data_bigtable %>% 
  filter(cell_grouping == 1) %>%
  select(
    verbatim_name, dataset, tp, # Grouping variables
    log_R2_1, Telfer_1_2, # Response variables
    Total_area, # Extent of the Arena
    relative_occupancy_Ncells, # Relative Occupancy
    m_AOO_s, # slope of OAR1
    m_relOcc_s, # slope of OAR2
    D_AOO_s, # D of AOO
    D_relOcc_s # D of rel. Occupancy
    )


## Calculate Diversity Measures ======================
GammaAlphaBeta_Atlas <- pres_dat_final %>%
  filter(cell_grouping == 1) %>%
  select(dataset, tp, cell_label, verbatim_name) %>% distinct() %>%
  group_by(dataset,tp) %>%
  mutate(GammaSR = sum(n_distinct(verbatim_name))) %>% ungroup() %>%
  group_by(dataset, tp, cell_label) %>%
  mutate(AlphaSR = sum(n_distinct(verbatim_name))) %>%
  mutate(BetaSR = GammaSR/AlphaSR)

GammaAlphaBeta_Species <- GammaAlphaBeta_Atlas %>%   
  ungroup() %>%
  group_by(dataset, tp, verbatim_name) %>%
  mutate(AlphaSR_sp = mean(AlphaSR)) %>%
  mutate(BetaSR_sp = GammaSR/AlphaSR_sp) %>%
  select(dataset, tp, verbatim_name, AlphaSR_sp, BetaSR_sp, GammaSR) %>% distinct()

predictors_df2 <- merge(predictors_df, GammaAlphaBeta_Species, by=c("dataset", "tp", "verbatim_name"), all = T)

## Calculate Mean Sampling Effort  ======================
AvgEffort <- pres_dat_final %>%
  filter(cell_grouping == 1) %>%
  select(dataset, tp, cell_label, verbatim_name, samp_effort_type, effort) %>% 
  distinct() %>%
  group_by(dataset, tp, verbatim_name) %>%
  summarize(avgEffort = mean(effort))


predictors_df3 <- merge(predictors_df2, AvgEffort, intersect(names(predictors_df2), names(AvgEffort)), all = T)










# Extract more predictor data from the grids:
grid_list2
grid_list3 <- list()
for (i in seq_along(grid_list2)){
  cell1grid <- grid_list2[[i]][[1]]
  grid_list3[[i]] <- cell1grid
  
}
# rast <- terra::rast(grid_list2[[1]][[7]]) 
# 
# pli <- mosaic_to_pliman(rast)
# plot(pli)
# 
# poly_measure(poly)
# object_contour(grid_list2[[1]][[7]])

```

## Spatial Autocorrelation

ref: Carmen

```{r}
library(spdep)
library(sfdep)
## We need the highes resolution data = cell_grouping = 1

# grid data
grids <- list()
for (a in seq_along(grid_paths)) {
    grids_a<- sapply("cell1grid", function(i) {
      st_read(grid_paths[[a]], paste(i), quiet = TRUE)  %>% st_transform(crs = 4326) %>% reorder_levels( cell_grouping, order=desired_levels)
      }, simplify = FALSE)
    grids[[a]] <- grids_a
}

# Raw species occurrence data
# Species data  =====================
presence_data_all <- list()
for (i in seq_along(data_paths)){
  pres_dat <- readRDS(data_paths[i])
  sy <- sort(unique(pres_dat$start_year))
  
## Add time-period column 
  pres_dat2 <- pres_dat %>%     
    filter(cell_grouping == 1) %>%
    mutate(tp = ifelse(start_year == sy[1], 1, 2)) %>% 
    reorder_levels( cell_grouping, order=desired_levels)
  
  ## Filter for cells that have been sampled twice ============== (!!)
  pres_dat3 <- pres_dat2 %>% ungroup() %>% 
    group_by(cell_label) %>%
    mutate(num_periods = n_distinct(tp)) %>%
    mutate(repeated = ifelse(num_periods == 2, 1, 0)) %>%
    filter(repeated == 1)
  
  ## Filter for species that have change data (sp that occur in both time periods)
  common_species <- pres_dat3 %>%
    group_by(verbatim_name) %>%
    summarise(num_periods = n_distinct(tp)) %>%
    filter(num_periods == 2) %>%
    pull(verbatim_name)
  
  pres_dat4 <- pres_dat3 %>% filter(verbatim_name %in% common_species)

  presence_data_all[[i]] <- pres_dat4
}

# remove tp3 from CZ data for easier handling of all datasets
presence_data_all[[1]] <- presence_data_all[[1]] %>% 
  filter(start_year != 2014)


## Filter for cells that have been sampled twice =====================================


## autocorrelation loop


out_list <- list()
time_periods <- c(1,2)
atlas_names <- c("Birds_Atlas_Czechia", "Birds_Atlas_New_York","Birds_atlas_Japan", "Birds_atlas_EBBA")
presence_sf_list <- list()

for (a in seq_along(atlas_names)){
  grid <- grids[[a]]$cell1grid
  presence_data <- presence_data_all[[a]]
  presence_sf <- left_join(grid, presence_data)
  dd <- presence_sf %>% filter(dataset == atlas_names[a])
  presence_sf_list[[a]] <- dd


  for (y in seq_along(time_periods)){
    dd1 <- dd %>% filter(tp == time_periods[y])
    
    ## From Carmen ===============================
    
    sp_list <- unique(dd1$verbatim_name)
    # Contiguity methods
    neighbor_method <- "contiguity"
    # Output columns
    columns_df <- c("tp", "dataset", "neighbor_method", "mean_area", "mean_area_cropped")
    spmor_cols <- c("verbatim_name", "global_moran", "p_value", columns_df)
    spmoran_df <- data.frame(matrix(nrow = length(sp_list), ncol = length(spmor_cols)))
    colnames(spmoran_df) <- spmor_cols

    row_id <- 1
    
        
    for (s in seq_along(sp_list)) {
      # Obtain a df for each species that indicates the presence (1) or absence (0) of the species
      data_species <- dd1 %>%
        mutate(verbatim_name = ifelse(verbatim_name != sp_list[s], NA, verbatim_name)) %>%
        group_by(across(-verbatim_name)) %>%
        slice(which.max(!is.na(verbatim_name))) %>%
        mutate(presence = ifelse(!is.na(verbatim_name), 1, 0))
      
      # Filling in the data
      spmoran_df$verbatim_name[row_id] <- sp_list[s]
      spmoran_df$dataset[row_id] <- atlas_names[a]
      spmoran_df$neighbor_method[row_id] <- neighbor_method
      spmoran_df$tp[row_id] <- unique(data_species$tp)
      spmoran_df$mean_area[row_id] <- mean(data_species$area, na.rm = TRUE)
      spmoran_df$mean_area_cropped[row_id] <- mean(data_species$area_cropped, na.rm = TRUE)

      tryCatch({
      # Creating neighbors
      nb <- poly2nb(data_species, queen = TRUE)
      # Spatial weights for the neighbors
      listw <- nb2listw(nb, style = "W", zero.policy = TRUE)
      # Moran's I
      moran_res <- moran.test(data_species$presence, listw, zero.policy = TRUE)
      spmoran_df[row_id, "global_moran"] <- as.numeric(moran_res$estimate)[1]
      spmoran_df[row_id, "p_value"] <- moran_res$p.value
      }, error = function(e) {
        # Handle the case where Moran's I cannot be calculated
        spmoran_df[row_id, c("global_moran", "p_value")] <- NA
      })

      row_id <- row_id + 1  # Update row_id for the next entry
    
      }
    
    out_list[[length(out_list) + 1]] <- spmoran_df
  
  }
  
}
saveRDS(presence_sf_list, paste0(out_path, "presence_sf_list.rds"))
SAC_df <- plyr::rbind.fill(out_list, fill = T) %>% distinct()
write.csv(SAC_df, paste0(out_path, "SAC_data.csv"))

```


