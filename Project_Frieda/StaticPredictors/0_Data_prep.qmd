---
title: "0. Data Preparation"
author: "Friederike WÃ¶lke"
format: html
editor: visual
---

# Predicting temporal change from static patterns

------------------------------------------------------------------------

Note: this is the first script used to study whether temporal change can be predicted from patterns that are collected once and do not change through time that we can find in nature (i.e., hereafter referred to as 'static pattern').\
Here we will prepare the data that will be used to predict temporal change.

In theory, it should be possible to partition the variance in species-level temporal change data into several factors that might play a role in the prediction. These 'predictors' are classified into several groups that describe different characteristics of the species, their ecological niche, their evolutionary history, the 'arena' which is being studied, and geometrical/statistical forces that could determine how the model predicts change.

The study's novelty derives from including geometrical, statistical and non-biological drivers in predicting temporal biodiversity change. The idea is that the statistical, geometrical, spatial and temporal limits of our study area and data collection might determine partially the result that can be predicted from the data.

We would expect that if a larger extent or a different scale is studied, temporal change patterns might depend on the situation. For example, in a small country, the magnitude of population increase is limited by the countries' borders, although the species range is most probably not (if there is no barrier or human intervention - e.g. Hunting). Thus, larger magnitudes of change can be detected on cross-border studies than it is structurally possible on a national scale.

\
In a similar manner, we would expect that the geometrical properties of our study area can determine the results that our models are able to predict. One example would be the distribution of the species range inside the country. Where the spread of a species across the 'arena' (i.e., study area) naturally limits the species range inside the arena by arbitrary (country) borders which might not match with ecological borders. In addition, solely due to geometrical constraints, more species can move northward with climate in a country that follows an elongated East-West direction compared to one that is North-South elongated. We suggest that the borders of the study area introduce a 'veil' to the actual underlying temporal change processes that are happening, thereby masking the true temporal change dynamics. However, since species assessments take place on a country scale, it may be possible to use the predictive strength of geometry and characteristics of the arena to enhance our predictive capacity on national scales.

### Table 1: List of static predictors used to predict temporal biodiversity change

(Part 1: Predicting future change: can data from the 80s predict the temporal change that took place between the 80s and 00s?\
\
Part 2: Predicting past change: can data from the 00s predict the temporal change that took place between the 80s and 00s?)

| Predictor group                                                                                                                                                               | Predictor sub-group                                              | Predictor                                                                                                                                                                                                          | Source                                                                                            | Status              | Note                                                                                                            |
|------------|------------|------------|------------|------------|------------|
| Species traits                                                                                                                                                                | Evol. constrain                                                  | Phylogenetic distinctness                                                                                                                                                                                          | calculated from Jetz 2012 BirdTree (taken from Weeks et al 2022 data repository)                  | \- \[x\]            | Fair proportion metric (Isaac et al., 2007).                                                                    |
| Species traits                                                                                                                                                                |                                                                  | Species Genus, Family, Order                                                                                                                                                                                       | AVONET                                                                                            | \- \[...\]          | Genus not included so far                                                                                       |
|                                                                                                                                                                               | Threat Status                                                    | IUCN Global/Continental/National Red List for species                                                                                                                                                              | IUCN                                                                                              | \- \[...\]          | Don't have the national one yet \[\[Questions & Ideas\]\]                                                       |
|                                                                                                                                                                               | \% Occurrence in threatened habitat OR classification of species | IUCN Red List of threatetend terrestrial and freshwater habitats in Europe OR Jiri Reif Populations of farmland birds (Ref: Rosenberg 2019: introduced, landbird, shorebirds, waterbirds, waterfowl, agricultural) | IUCN                                                                                              | \- \[ \]            | I don't have this data in a usable format. Maybe in combination with land cover data? \[\[Questions & Ideas\]\] |
|                                                                                                                                                                               | Dispersal trait                                                  | Hand-Wing-Index (Flight intensity), mIgratory status, trophic strategy.. check Paper by Stoch 2023                                                                                                                 | AVONET                                                                                            | \- \[x\]            | from Weeks et al 2022 data repository                                                                           |
|                                                                                                                                                                               | Scale-Area-Relationship                                          | slope of lm(log(AOO)\~log(scale)) <br>intercept of lm(log(AOO)\~log(scale))                                                                                                                                        | calculated from CZ Atlas 1 (future change) and 2 (past change)                                    | \- \[x\]            |                                                                                                                 |
|                                                                                                                                                                               | Occupancy                                                        | AOO                                                                                                                                                                                                                | calculated from CZ Atlas 1 (future change) and 2 (past change)                                    | \- \[x\]            |                                                                                                                 |
|                                                                                                                                                                               |                                                                  | Relative occupancy N cells -\> this                                                                                                                                                                                | calculated from CZ Atlas 1 (future change) and 2 (past change)                                    | \- \[x\]            |                                                                                                                 |
|                                                                                                                                                                               |                                                                  | Occupancy N cells                                                                                                                                                                                                  | calculated from CZ Atlas 1 (future change) and 2 (past change)                                    | \- \[x\]            |                                                                                                                 |
|                                                                                                                                                                               | Geometry                                                         | orientation of distribution (n-s, e-w)? - center of gravity, how far it is away from the border - Sothernness \* Arena Size // Westernness --\> major pressure from invasion                                       |                                                                                                   | \- \[ \]            | discuss with P \[\[Questions & Ideas\]\]                                                                        |
|                                                                                                                                                                               |                                                                  | some summary metric calculated from cell-properties for each species (area, shape, length, perimeter, sampling effort)                                                                                             |                                                                                                   | \- \[ \]            | discuss with P \[\[Questions & Ideas\]\]                                                                        |
|                                                                                                                                                                               | Statistical patterns                                             | spational autocorrelation: Global for species                                                                                                                                                                      | from Carmen                                                                                       | \- \[ \]            | talk to Carmen #Tasks                                                                                           |
|                                                                                                                                                                               |                                                                  | regression-to-mean -\> exclude and only look at Occupancy                                                                                                                                                          | Calculated from best sampled cells                                                                | \- \[ \]            | as offset? #Tasks                                                                                               |
|                                                                                                                                                                               | Environmental                                                    | Climate space and area ? -\> Niche (local or global eBird) (continental)                                                                                                                                           | e.g. from CHELSA                                                                                  | \- \[ \]            | discuss with P \[\[Questions & Ideas\]\]                                                                        |
|                                                                                                                                                                               |                                                                  | Topography/Elevation --\> EU scale                                                                                                                                                                                 | from geodata R package                                                                            | \- \[x\]            |                                                                                                                 |
|                                                                                                                                                                               | Global Range Size                                                | -\> https://datazone.birdlife.org/home                                                                                                                                                                             | IUCN rangemaps for global; Range.Size from Weeks et al 2022 // https://datazone.birdlife.org/home | \- \[x\]            |                                                                                                                 |
|                                                                                                                                                                               | Species Interactions                                             | Co-occurrence probability                                                                                                                                                                                          | calculated from CZ atlas for inside CZ;<br>EU BBS for outside of CZ                               | \- \[x\]<br>- \[ \] | discuss with P \[\[Questions & Ideas\]\]                                                                        |
|                                                                                                                                                                               |                                                                  |                                                                                                                                                                                                                    |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               |                                                                  |                                                                                                                                                                                                                    |                                                                                                   | \- \[ \]            |                                                                                                                 |
| Characteristics of the 'arena'<br><br>(i.e., the area across which we study change)<br><br>--\> we need at least 2 different Atlases together to make this a useful predictor |                                                                  | Extent                                                                                                                                                                                                             |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               |                                                                  | Perimeter                                                                                                                                                                                                          |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               | Geometry                                                         | Orientation/Shape ? - index of elongation                                                                                                                                                                          |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               |                                                                  | \% of threatened species per country/'arena'                                                                                                                                                                       |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               |                                                                  | \% threatened habitats per country/'arena'                                                                                                                                                                         |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               | Biological                                                       | total Species Richness                                                                                                                                                                                             |                                                                                                   | \- \[ \]            |                                                                                                                 |
|                                                                                                                                                                               | Sampling in Atlas --- Biases of Atlasses                         | average local richness, beta diversity, equilibrium species richness, ratio = gamma                                                                                                                                |                                                                                                   | \- \[ \]            |                                                                                                                 |

### 00. Libraries

```{r, print = false}
#| label: setup libraries

rm(list=ls()) # clean environemnt
gc() # clean memory


# Spatial data ------------------------------- # 
library(sf)
library(terra)
library(tmap)

# Standard data handling --------------------- #
library(readxl)
library(dplyr)
library(ggplot2) # plotting
library(tidyr)
library(tibble)

# Phylogeny handling ------------------------- #
library(ape)


# Landscape metrics --------------------------- #
#install.packages("landscapemetrics")
library(landscapemetrics)
```

### 0. Source and Sink folders

```{r}
# folder path to output folder
out_path <- "c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/GitHub/BEAST_General_Procedures/Project_Frieda/StaticPredictors/out/"

# atlas data (species and grids)
source_path_country <- "c:/Users/wolke/OneDrive - CZU v Praze/Datasets/Processed/Atlases/Replicated/"

# path to external data
predictors_path <- "~/PhD_Projects/StaticPredictors/Data/"
```

### I. Atlas data

-   used to calculate:

    -   spatial predictors

    -   characteristics of the 'arena'

    -   distribution / AOO of species

    -   Fractal dimension of a species' distribution

```{r}
#| label: setup data paths

# create path to read in data and grids from variables
# CZ Atlas
data_path1 <- paste0(source_path_country,"Birds_Atlas_Czechia/Birds_Atlas_Czechia_beast_data.rds")
grid_path1 <- paste0(source_path_country,"Birds_Atlas_Czechia/Birds_Atlas_Czechia_grid.gpkg")

# NY Atlas
data_path2 <- paste0(source_path_country,"Birds_Atlas_New_York/Birds_Atlas_New_York_beast_data.rds")
grid_path2 <- paste0(source_path_country,"Birds_Atlas_New_York/Birds_Atlas_New_York_grid.gpkg")

# Japan Atlas
data_path3 <- paste0(source_path_country,"Birds_Atlas_Japan/Birds_Atlas_Japan_beast_data.rds")
grid_path3 <- paste0(source_path_country,"Birds_Atlas_Japan/Birds_Atlas_Japan_grid.gpkg")

# European Atlas
data_path4 <- paste0(source_path_country,"Birds_Atlas_EBBA/Birds_Atlas_EBBA_beast_data.rds")
grid_path4 <- paste0(source_path_country,"Birds_Atlas_EBBA/Birds_Atlas_EBBA_grid.gpkg")

```

```{r}
project_crs <- '+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +ellps=WGS84 +units=m +no_defs'


# Step 1: get a gridded world
world <- st_read("~/PhD_Projects/StaticPredictors/Data/World_administrative_borders_shp/world-administrative-boundaries.shp")
world <- st_transform(world, crs=project_crs)
world_extent <- ext(world)
grid <- rast(world_extent, res = 0.09, crs = project_crs)


grid_world <- vect("~/PhD_Projects/StaticPredictors/Data/AOOGrid_10x10kmShp/AOOGrid_10x10km.shp")
grid_world <- transform(grid_world, crs=project_crs)



# grid_world <- st_read("~/PhD_Projects/StaticPredictors/Data/AOOGrid_10x10kmShp/AOOGrid_10x10km.shp")
# 
# grid_cropped <- st_crop(grid_world, world)
# #   Transforming sf class to SpatVector class from terra
# grid_world_v <- vect(grid_world)
# 
# #   Masking in terra
# world_grid_masked = mask(world, grid_world_v)



gc()
# head(grid_world)
# st_crs(grid_world)
# st_crs(world)
# 
# world <- st_transform(world, crs=project_crs)
# grid_world <- st_transform(grid_world, crs=project_crs)
# 
# 
# grid_world2 <- rast(ext(world), res = 10000, crs = project_crs)
# 
# world2<- st_join(world, grid_world)





# ggplot(grid_world)+
#   geom_sf() +
#   geom_sf(data = world, fill = NA, color = "black") +
#   theme_void()


# Step 2:'Arena' grids:

## Czech Republic:
grid_CZ <- st_read(grid_path1, layer = "cell1grid")
grid_CZ2 <- grid_CZ %>% select(!area3s)
grid_CZ3 <- unique(grid_CZ2)

extent_CZ <- round(st_bbox(grid_CZ3),0) + c(1,-1,1,1)

grid_CZ4 <- terra::vect(grid_CZ3)
grid_CZ <- grid_CZ4
```

### 2. Static Predictors

#### 2.1 Species traits

```{r}
tree_path <- paste0(predictors_path, "Weeks_et_at_2022/singe_bird_phylo.tre")
traits_path <- paste0(predictors_path, "AVONET/ELEData/TraitData/AVONET3_BirdTree.xlsx")
threat_path <- paste0(predictors_path, "European Red List of birds (2021)/EU_red_list_2021.csv")
fractal_path <- "c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/GitHub/BEAST_General_Procedures/Project_Frieda/StaticPredictors/out/Big_table_CZ_JP_NY.csv"


Chelsa_path <- "~/PhD_Projects/StaticPredictors/Data/Chelsa_Bio_PET/"
# threat_path2 <- "~/../Datasets/Raw/National Red List database/nrl_simplified_table.txt"
# glob_range_path <- "~/../Datasets/Raw/Distributions/BIrds_of_the_world/BOTW.gdb"

```

#### 2.1.2 Handle BirdLife GeoDatabase

Some Explanations (from the metadata document):

> Presence:
>
> -   1 = extant
>
> -   2 = Probably extant (N.B.)
>
> -   3 = Possibly Extant
>
> -   4 = Possibly extinct
>
> -   5 = Extinct (post 1500)
>
> -   6 = Presence Uncertain
>
> Origin:
>
> -   1 = Native
>
> -   2 = Reintroduced
>
> -   3 = Introduced
>
> -   4 = Vagrant
>
> -   5 = Origin uncertain
>
> -   6 = assisted colonization
>
> Season:
>
> -   1 = Resident
>
> -   2 = Breeding Season
>
> -   3 =Non-breeding Season
>
> -   4 = Passage
>
> -   5 = Seasonal Occurrence Uncertain

```{r}
require(sf)
require(dplyr)

fractal_data <- read.csv(fractal_path)
sp_list_all <- fractal_data %>% select(dataset, verbatim_name) %>% distinct()

# The input file geodatabase
fgdb <- "c:/Users/wolke/OneDrive - CZU v Praze/Datasets/Raw/Distributions/Birds_of_the_world/BOTW.gdb"

st_layers(fgdb)
st_read(fgdb)
All_sp <- st_read(fgdb, layer = "All_Species") 
Tax_sp <- st_read(fgdb, layer = "Taxonomic_checklist") # Global Red List status

Subset_Tax_sp <- Tax_sp %>% filter(ScientificName %in% sp_list_all$verbatim_name) %>% select(ScientificName, FamilyName, Subfamily, Tribe, RL_Category)
Subset_all_sp <- All_sp %>% filter(sci_name %in% sp_list_all$verbatim_name) %>% filter(presence %in% c(1,3),
                                                                                       origin %in% c(1,2),
                                                                                       seasonal %in% c(1,2,4))


library(maps)
maps::map('world')
plot(Subset_all_sp, col='red', add=T)


```

#### 2.1.3 Handle National and Global Red List status

```{r}
library(stringr)
nrl_path <-"c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/PhD_Projects/StaticPredictors/Data/NationalThreatsAves_subset/nrl_simpified_table_Aves.txt" 

sp_names_JP <- read.csv("c:/Users/wolke/OneDrive - CZU v Praze/Datasets/Processed/Atlases/Replicated/Birds_atlas_Japan/Birds_atlas_Japan_spnames_INFO.csv")

nrl <- read.csv(nrl_path, sep="\t")
nrl[c('Species', 'Subspecies')] <- str_split_fixed(nrl$Species, ' ', 2)
nrl$Verbatim_name <- str_c(nrl$Genus," ", nrl$Species)

nrl <- nrl %>% filter(Nation %in% c("Czech Republic", "Japan")) 
nrl %>% filter(Verbatim_name %in% sp_list_all$verbatim_name ) # only 25 species match...
  

str(nrl)
```

#### 2.1.4 Life History traits (N=45/237)

```{r}
storchova <- "c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/PhD_Projects/StaticPredictors/Data/Storchova_LifeHistoryBirdsEU/Life-history characteristics of European birds.txt"

lifehistory <- read.csv(storchova, sep="\t")

intersect(lifehistory$Species, sp_list_all$verbatim_name)
```

#### 2.2 Environmental predictors

##### 2.2.1 CHELSA climate data

calculating the global climate niche of species...

```{r}
library(stars)
project_crs <- '+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +ellps=WGS84 +units=m +no_defs'

# Resample to new resolution, projection 
# tavg <- resample(grid_world, r, method = "bilinear")
# footp <- resample(footp, r, method = "near")

# Chelsa climate data to calculate climate space (to calculate species niches)
c_layers <- list.files(Chelsa_path)
c_layers_names <- setNames( c("bio1", "bio12", "bio13", "bio14", "bio15", "bio2", "bio3", "bio4", "bio5", "bio6", "bio7", "pet"), c_layers)

r_list <- list()

#i = 1
for (i in seq_along(c_layers_names)){


### Step 1: read in bio clim layers separately, extract values from grid cells
  temp_layer_name <- c_layers[i]
  l <- terra::rast(paste0(Chelsa_path, temp_layer_name))
  names(l) <- (c_layers_names[i])

  #l_poly <- as.polygons(l)
  #l_agg <- terra::aggregate(l_poly, grid)
  #coarse_chelsa <- aggregate(l, fact = 2, fun = mean, na.rm = TRUE)  
  
  ####
  l_values <- terra::extract(l, grid, fun = mean) # all values per grid cell
  #l_values <- terra::resample(l, grid) ## Throws error: Warnung: [resample] Estimated disk space needed without compression: 216445103GB. Available: 685 GB.Error: [resample] interrupted

# Average across cells
  l_vals <- l_values %>%
    group_by(ID) %>%
    reframe(mean_var = mean(l_values[,2])) %>%
    rename_with(.cols = mean_var, function(x){paste0(c_layers_names[i], "_", "mean")}) 
  
  
  

  
  # l2 <- terra::extract(l, grid)
  # l3 <- terra::crop(l, grid)
  # plot(mask(l3, grid))
  # 
  # pol <- terra::as.polygons(l2)
  # sf_new <- sf::st_as_sf(pol)
  # r_list[[i]] <- l
}

data.frame(grid)
rast_list <- raster::stack(r_list)
class(rast_list[[1]])

world <- rgdal::readOGR("~/PhD_Projects/StaticPredictors/Data/World_administrative_borders_shp/world-administrative-boundaries.shp")

raster::extract(rast_list[[1]], world)


names(Chelsa_dd) # layer names
dim(Chelsa_dd) # Dimensions
res(Chelsa_dd) # Resolution
crs(Chelsa_dd) # Crs
nlyr(Chelsa_dd) # Number of Layers

rasterToPoints(Chelsa_dd[[1]])

landcover_CZ <- st_read(paste0(predictors_path, "CorineLandCover90s/")) #class(vect(landcover))
lc <- rast(landcover_CZ)



### Function to transform raster to sf


pol_py <- sf::st_as_sf(terra::as.polygons(r_list[[1]]))

####


```
