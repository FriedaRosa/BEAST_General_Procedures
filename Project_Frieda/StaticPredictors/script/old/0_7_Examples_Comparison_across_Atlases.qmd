---
title: "Examples:Comparison across Atlases"
author: "Friederike WÃ¶lke"
format: html
editor: visual
---

### Plots: Comparing across Atlases

```{r}
rm(list=ls())
library(ggthemes); library(cowplot); library(gridExtra); library(dplyr); library(sf); library(rstatix); library(ggplot2)
sf_use_s2(FALSE)

### The paths ===
source_atlas <- c("c:/Users/wolke/OneDrive - CZU v Praze/Datasets/Processed/Atlases/Replicated/")
source_predictors <- c("c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/PhD_Projects/StaticPredictors/Data/")
source_Git <- c("c:/Users/wolke/OneDrive - CZU v Praze/Dokumenty/GitHub/BEAST_General_Procedures/Project_Frieda/StaticPredictors/")

# folder path to atlas data
source_paths <- c(paste0(source_atlas, "Birds_Atlas_Czechia/"), 
                  paste0(source_atlas, "Birds_Atlas_New_York/"), 
                  paste0(source_atlas, "Birds_atlas_Japan/"), 
                  paste0(source_atlas, "Birds_atlas_EBBA/"))

# folder path to output folder
out_path <- c(paste0(source_Git, "out/"))

# create path to read in data and grids from variables
data_paths <- c(paste0(source_paths[1],"Birds_Atlas_Czechia_beast_data.rds"), 
                paste0(source_paths[2], "Birds_Atlas_New_York_beast_data.rds"), 
                paste0(source_paths[3], "Birds_atlas_Japan_beast_data.rds"),
                paste0(source_paths[4], "Birds_atlas_EBBA_beast_data.rds"))

grid_paths <- c(paste0(source_paths[1],"Birds_Atlas_Czechia_grid.gpkg"), 
                paste0(source_paths[2], "Birds_Atlas_New_York_grid.gpkg"), 
                paste0(source_paths[3], "Birds_atlas_Japan_grid.gpkg"),
                paste0(source_paths[4], "Birds_atlas_EBBA_grid.gpkg"))

atlas_names <- c("Birds_Atlas_Czechia", "Birds_Atlas_New_York","Birds_atlas_Japan", "Birds_atlas_EBBA")
# Define the desired order of factor levels
desired_levels <- factor(c("1", "2","4", "8", "16", "32", "64", "128"), ordered = T,  levels = c("1", "2","4", "8", "16", "32", "64", "128")) 


### The data ===

## We need the highes resolution data = cell_grouping = 1

# grid data =====================
grids <- list()
for (a in seq_along(grid_paths)) {
    grids_a <-sapply("cell1grid", function(i) {
      st_read(grid_paths[[a]], paste(i), quiet = TRUE)  %>% 
        st_transform(crs = 4326) %>% 
        reorder_levels( cell_grouping, order=desired_levels)
      }, simplify = FALSE)
    grids[[a]] <- grids_a$cell1grid
}

# Species data  =====================
presence_data_all <- list()
for (i in seq_along(data_paths)) {
  pres_dat <- readRDS(data_paths[i])
  sy <- sort(unique(pres_dat$start_year)) # sy = start_year

  ## Add time-period column
  pres_dat2 <- pres_dat %>% 
    mutate(tp = case_when(start_year == sy[1] ~ 1,
                          start_year == sy[2] ~ 2)) %>% 
    filter(tp %in% c(1,2)) %>%
    reorder_levels(cell_grouping, order=desired_levels)

  ## Cells sampled twice (column: repeated)
  common_cells <- pres_dat2 %>%
    ungroup() %>%
    group_by(dataset, cell_grouping, cell_label) %>%
    mutate(num_periods_cells = n_distinct(tp)) %>%
    mutate(repeated = case_when(
      num_periods_cells == 2 ~ 1,
      num_periods_cells %in% c(1, 2) ~ 0
    )) %>%
    ungroup() %>%
    group_by(dataset) %>%
    select(dataset, cell_grouping, cell_label, num_periods_cells, repeated) %>%
    unique()

  common_cells %>%
    group_by(dataset, cell_grouping, repeated, num_periods_cells) %>%
    summarise(n = n())

  presence_data_rep <- full_join(pres_dat2, common_cells)

  # Species sampled twice in the remaining cells
  common_sp <- presence_data_rep %>%
    filter(repeated == 1 & cell_grouping == 1) %>%
    group_by(dataset, verbatim_name) %>%
    summarise(num_periods_sp = n_distinct(tp)) %>%
    ungroup() 
  presence_data3 <- full_join(presence_data_rep, common_sp) 

  presence_data_all[[i]] <- presence_data3
}

##############


presence_sf_list <- readRDS(paste0(out_path, "rds/presence_sf_list.rds"))
big_tab <- read.csv(file=paste0(out_path, "csv/Big_table_CZ_JP_NY_EU.csv")) %>% 
  reorder_levels(cell_grouping, desired_levels)


## Find all species that are found in all atlas periods and in all atlases !!

big_tab1 <- big_tab %>% select(verbatim_name, dataset, tp) %>% distinct()
grouped <- big_tab1 %>%
  group_by(verbatim_name) %>%
  # Filter for species that occur in all levels of dataset
  filter(n_distinct(dataset) == n_distinct(unique(big_tab$dataset))) %>%
  distinct()
unique_species <- unique(grouped$verbatim_name) 
## Nice, there are 15 species that are found in all atlases!!! Yass!!!!

print(unique_species)
sp <- unique_species



### Now we can write a Loop to run through this list of species and make the plots for all of them :) This will be funnnnnn 

## Save individual grids for plotting =====
grid_CZ <- grids[[1]]
grid_NY <- grids[[2]]
grid_JP <- grids[[3]]
grid_EU <- grids[[4]]

## Get the Borders for plotting =====
library(rnaturalearth) 
EU <- ne_countries(continent = "europe", scale = 10, returnclass='sf') %>% st_crop(st_bbox(grid_EU))
CZ <- ne_countries(country = "czechia", scale = 10,  returnclass='sf') %>% st_crop(st_bbox(grid_CZ))

JP <- ne_countries(country = "japan", scale = 10, returnclass='sf') %>% st_crop(st_bbox(grid_JP))
# Load world map data
USA <- ne_states(returnclass = "sf", country = 'United States of America') 
NY <- USA[USA$name == "New York", ]
NY <- NY  %>% st_crop(st_bbox(grid_NY)) 

#sp <- "Ciconia nigra"
sp <- "Platalea leucorodi"

plot_list <- list()
for (i in seq_along(sp)){
  print(sp[i])
  
  tryCatch({
  pres_dat_CZ <- presence_sf_list[[1]] %>% st_make_valid() %>%
    filter(verbatim_name %in% sp[i]) %>% 
    left_join(., big_tab) %>% 
    distinct()
  pres_dat_NY <- presence_sf_list[[2]] %>% st_make_valid() %>%
    filter(verbatim_name %in% sp[i]) %>% 
    left_join(., big_tab) %>% 
    distinct()
  pres_dat_JP <- presence_sf_list[[3]] %>% st_make_valid() %>%
    filter(verbatim_name %in% sp[i]) %>% 
    left_join(., big_tab) %>% 
    distinct()
  pres_dat_EU <- presence_sf_list[[4]] %>%  st_make_valid() %>%
    filter(verbatim_name %in% sp[i]) %>% 
    left_join(., big_tab) %>% 
    distinct()
  }, error = function(err) {
})
  
  
    ## Plots ===
p_cz1 <- ggplot() + 
  geom_sf(data = grid_CZ, fill = NA)+
  geom_sf(data = pres_dat_CZ %>% filter(tp ==1 ), fill = "red")+
    geom_sf(data = CZ, fill = NA)+
  theme_bw()
p_cz2 <- ggplot() + 
  geom_sf(data = grid_CZ, fill = NA)+
  geom_sf(data = pres_dat_CZ %>% filter(tp ==2 ), fill = "red")+
    geom_sf(data = CZ, fill = NA)+
  theme_bw()

p_eu1 <- ggplot()+
  geom_sf(data = grid_EU, fill = NA)+
  geom_sf(data = pres_dat_EU %>% filter(tp ==1 ), fill = "red")+
      geom_sf(data = EU, fill = NA)+
  theme_bw()

p_eu2 <- ggplot()+
  geom_sf(data = grid_EU, fill = NA)+
  geom_sf(data = pres_dat_EU %>% filter(tp ==2 ), fill = "red")+
      geom_sf(data = EU, fill = NA)+
  theme_bw()

p_ny1 <- ggplot()+
  geom_sf(data = grid_NY, fill = NA)+
  geom_sf(data = pres_dat_NY %>% filter(tp ==1 ), fill = "red")+
      geom_sf(data = NY, fill = NA)+
  theme_bw()

p_ny2 <- ggplot()+
  geom_sf(data = grid_NY, fill = NA)+
  geom_sf(data = pres_dat_NY %>% filter(tp ==2 ), fill = "red")+
      geom_sf(data = NY, fill = NA)+
  theme_bw()

p_jp1 <- ggplot()+
  geom_sf(data = grid_JP, fill = NA)+
  geom_sf(data = pres_dat_JP %>% filter(tp ==1 ), fill = "red")+
      geom_sf(data = JP, fill = NA)+
  theme_bw()

p_jp2 <- ggplot()+
  geom_sf(data = grid_JP, fill = NA)+
  geom_sf(data = pres_dat_JP %>% filter(tp ==2 ), fill = "red")+
      geom_sf(data = JP, fill = NA)+
  theme_bw()
  
cz <- cowplot::plot_grid(p_cz1, p_cz2)
eu <- cowplot::plot_grid(p_eu1, p_eu2)
ny <- cowplot::plot_grid(p_ny1, p_ny2)
jp <- cowplot::plot_grid(p_jp1, p_jp2)
  
  sp_a <- big_tab  %>% filter(verbatim_name == sp[i]) 
gg1 <- ggplot(data = sp_a, aes(x = log10(mean_area), y = log10(AOO), col = dataset))+
    geom_point()+
    geom_smooth()+
    viridis::scale_color_viridis(discrete = T)+
    xlab("log Area")+
    ylab("log Occupancy")+
    labs(title = "Occupancy-Area Relationship", subtitle = paste(sp[i]))+
    theme_classic()+
    facet_wrap(tp~.)
  
  gg2 <- cowplot::plot_grid(gg1, NULL,  rel_heights = 0.5, rel_widths = 1, nrow=2)
  sum_tab <-  big_tab  %>% filter(verbatim_name == sp[i] & cell_grouping == 1) %>% select(verbatim_name, dataset, tp, AOO, relative_occupancy_area, D_AOO_a, log_R2_1, Telfer_1_2) %>% distinct()
  
pdf(file = paste0(out_path, sp[i], "_allAtlasMaps.pdf"), paper = "a4")

grid.arrange(tableGrob(sum_tab, theme = ttheme_minimal(base_size = 4)))
grid::grid.newpage() 
grid.arrange(cz)
grid.arrange(ny)
grid.arrange(eu)
grid.arrange(jp)
#grid::grid.newpage() 
grid.arrange(gg2)
dev.off()

plot_list[[i]] <- list(cz,eu,ny,jp, gg1)  
  
  
}
  
  
```
