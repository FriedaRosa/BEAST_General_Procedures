<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Friederike Wölke">
<meta name="dcterms.date" content="2024-04-20">

<title>Atlas Variables Calculations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="2_Atlas_Var_Calc_files/libs/clipboard/clipboard.min.js"></script>
<script src="2_Atlas_Var_Calc_files/libs/quarto-html/quarto.js"></script>
<script src="2_Atlas_Var_Calc_files/libs/quarto-html/popper.min.js"></script>
<script src="2_Atlas_Var_Calc_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2_Atlas_Var_Calc_files/libs/quarto-html/anchor.min.js"></script>
<link href="2_Atlas_Var_Calc_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2_Atlas_Var_Calc_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2_Atlas_Var_Calc_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2_Atlas_Var_Calc_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2_Atlas_Var_Calc_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#clean-environment" id="toc-clean-environment" class="nav-link active" data-scroll-target="#clean-environment"><span class="header-section-number">1</span> Clean Environment</a></li>
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries"><span class="header-section-number">2</span> Libraries</a></li>
  <li><a href="#load-environment" id="toc-load-environment" class="nav-link" data-scroll-target="#load-environment"><span class="header-section-number">3</span> Load Environment</a></li>
  <li><a href="#calculations" id="toc-calculations" class="nav-link" data-scroll-target="#calculations"><span class="header-section-number">4</span> Calculations</a>
  <ul class="collapse">
  <li><a href="#occupancy" id="toc-occupancy" class="nav-link" data-scroll-target="#occupancy"><span class="header-section-number">4.1</span> 1. Occupancy</a>
  <ul class="collapse">
  <li><a href="#calculate-areas-from-atlases" id="toc-calculate-areas-from-atlases" class="nav-link" data-scroll-target="#calculate-areas-from-atlases"><span class="header-section-number">4.1.1</span> 1.1 Calculate Areas from Atlases</a></li>
  <li><a href="#calculate-occupancy" id="toc-calculate-occupancy" class="nav-link" data-scroll-target="#calculate-occupancy"><span class="header-section-number">4.1.2</span> 1.2 Calculate Occupancy</a></li>
  </ul></li>
  <li><a href="#occupancy-area-relationship-oar" id="toc-occupancy-area-relationship-oar" class="nav-link" data-scroll-target="#occupancy-area-relationship-oar"><span class="header-section-number">4.2</span> 2. Occupancy-Area-Relationship (OAR)</a>
  <ul class="collapse">
  <li><a href="#mark-saturated-scales" id="toc-mark-saturated-scales" class="nav-link" data-scroll-target="#mark-saturated-scales"><span class="header-section-number">4.2.1</span> 2.1 Mark saturated scales</a></li>
  <li><a href="#calculate-oar-fractal-dimension" id="toc-calculate-oar-fractal-dimension" class="nav-link" data-scroll-target="#calculate-oar-fractal-dimension"><span class="header-section-number">4.2.2</span> 2.2 Calculate OAR &amp; Fractal Dimension</a></li>
  </ul></li>
  <li><a href="#telfer-index-of-relative-change" id="toc-telfer-index-of-relative-change" class="nav-link" data-scroll-target="#telfer-index-of-relative-change"><span class="header-section-number">4.3</span> 3. Telfer index of relative change</a></li>
  <li><a href="#log-ratio-of-change-in-occupancy" id="toc-log-ratio-of-change-in-occupancy" class="nav-link" data-scroll-target="#log-ratio-of-change-in-occupancy"><span class="header-section-number">4.4</span> 4. Log Ratio of Change in Occupancy</a>
  <ul class="collapse">
  <li><a href="#long-to-wide-format" id="toc-long-to-wide-format" class="nav-link" data-scroll-target="#long-to-wide-format"><span class="header-section-number">4.4.1</span> 4.1 Long to wide format</a></li>
  </ul></li>
  <li><a href="#calculate-log-ratio-of-occupancy-change" id="toc-calculate-log-ratio-of-occupancy-change" class="nav-link" data-scroll-target="#calculate-log-ratio-of-occupancy-change"><span class="header-section-number">4.5</span> 4.2 Calculate Log Ratio of Occupancy Change</a></li>
  </ul></li>
  <li><a href="#save-output" id="toc-save-output" class="nav-link" data-scroll-target="#save-output"><span class="header-section-number">5</span> Save Output:</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Atlas Variables Calculations</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Friederike Wölke </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 20, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="clean-environment" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Clean Environment</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          used (Mb) gc trigger (Mb) max used (Mb)
Ncells  576711 30.8    1317535 70.4   660420 35.3
Vcells 1050583  8.1    8388608 64.0  1770238 13.6</code></pre>
</div>
</div>
</section>
<section id="libraries" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Libraries</h1>
<div class="cell" data-mesaage="false">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.2, GDAL 3.7.2, PROJ 9.3.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_use_s2</span>(<span class="cn">FALSE</span>) <span class="co"># switch spherical geometry off</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Spherical geometry (s2) switched off</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data handling:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstatix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attache Paket: 'rstatix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Das folgende Objekt ist maskiert 'package:stats':

    filter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attache Paket: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Die folgenden Objekte sind maskiert von 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Die folgenden Objekte sind maskiert von 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># library(plyr) </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">## plyr is required but produces some issues with dplyr. Thus it will be called in each function individually and is not required to load here.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Telfer calculation:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">## sparta is not on CRAN and cannot be updated as usual because there is another package called sparta from CRAN but we don't want this.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># library(devtools)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># install_github('biologicalrecordscentre/sparta')</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sparta) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Lade nötiges Paket: lme4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Lade nötiges Paket: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attache Paket: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Die folgenden Objekte sind maskiert von 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
</div>
</section>
<section id="load-environment" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Load Environment</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../../out/RData/1_Atlas_Data_clean.RData"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "atlas_names"        "crs_list"           "data_paths"        
 [4] "desired_levels"     "grid_list"          "grid_paths"        
 [7] "out_path"           "presence_data_filt" "source_atlas"      
[10] "source_Git"         "source_paths"       "source_predictors" 
[13] "time_periods"      </code></pre>
</div>
</div>
</section>
<section id="calculations" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Calculations</h1>
<section id="occupancy" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="occupancy"><span class="header-section-number">4.1</span> 1. Occupancy</h2>
<section id="calculate-areas-from-atlases" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="calculate-areas-from-atlases"><span class="header-section-number">4.1.1</span> 1.1 Calculate Areas from Atlases</h3>
<div class="cell" data-mesaage="false">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pres_dat_full_grain <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>pres_dat_full_atlas <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n_atlas <span class="cf">in</span> <span class="fu">seq_along</span>(atlas_names)){</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  atlas_name <span class="ot">&lt;-</span> atlas_names[n_atlas] <span class="co"># set variable for current run of the loop</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  atlas <span class="ot">&lt;-</span> grid_list[[n_atlas]] <span class="co"># subset list of atlases to one</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (grain <span class="cf">in</span> <span class="fu">seq_along</span>(atlas)){</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set some variables for current run of the loop</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    grain_a <span class="ot">&lt;-</span> <span class="fu">names</span>(atlas)[grain]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    grain_d <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">D"</span>, <span class="st">""</span>, grain_a)) <span class="co"># "\\D" = remove all non-numbers</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># subset atlas to one grain</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    atlas_1scale <span class="ot">&lt;-</span> atlas[[grain]] <span class="sc">%&gt;%</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(cell_grouping, cell_label, area, cell_long, cell_lat) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_drop_geometry</span>()</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="do">## =============================================================== </span><span class="al">###</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="do">## ================= Calculate Areas ============================= </span><span class="al">###</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="do">## =============================================================== </span><span class="al">###</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total Area and Total number of cells of the Atlas (as measured from grid)</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    atlas_1scale <span class="ot">&lt;-</span> atlas_1scale <span class="sc">%&gt;%</span> </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(cell_grouping) <span class="sc">%&gt;%</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">Total_area =</span> <span class="fu">sum</span>(atlas_1scale<span class="sc">$</span>area),</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">Total_Ncells =</span> <span class="fu">n_distinct</span>(cell_label))</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total number of sampled cells and total Area sampled per sampling period</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    Total_Ncells_samp <span class="ot">&lt;-</span> presence_data_filt <span class="sc">%&gt;%</span> </span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(dataset <span class="sc">==</span> atlas_name <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> grain_d) <span class="sc">%&gt;%</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(dataset, cell_grouping, cell_label, area) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(dataset, cell_grouping) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(cell_label, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_cells =</span> <span class="fu">n_distinct</span>(cell_label),</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">area_samp =</span> <span class="fu">sum</span>(area)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(n_cells, area_samp)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add columns to atlas</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    atlas_1scale<span class="sc">$</span>Total_area_samp <span class="ot">&lt;-</span> Total_Ncells_samp<span class="sc">$</span>area_samp</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    atlas_1scale<span class="sc">$</span>Total_Ncells_samp <span class="ot">&lt;-</span> Total_Ncells_samp<span class="sc">$</span>n_cells</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    map_atlas_1scale <span class="ot">&lt;-</span> atlas_1scale</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># subset the presence/absence data to the current spatial grain:</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    pres_data_1atlas <span class="ot">&lt;-</span> presence_data_filt <span class="sc">%&gt;%</span> </span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(dataset <span class="sc">==</span> atlas_name) <span class="sc">%&gt;%</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(cell_grouping <span class="sc">==</span> grain_d) <span class="sc">%&gt;%</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(dataset, tp, verbatim_name, cell_label, cell_grouping)</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add Areas to data</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    pres_data_full_1atlas <span class="ot">&lt;-</span> <span class="fu">left_join</span>(map_atlas_1scale, pres_data_1atlas)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    pres_data_full_1atlas <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(verbatim_name))</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    pres_data_full_1atlas<span class="sc">$</span>dataset <span class="ot">&lt;-</span> atlas_names[n_atlas]</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    pres_dat_full_grain[[grain]] <span class="ot">&lt;-</span> pres_data_full_1atlas <span class="sc">%&gt;%</span> </span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(verbatim_name))</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  pres_dat_grain2 <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(pres_dat_full_grain, <span class="at">fill=</span>T)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  pres_dat_full_atlas[[n_atlas]] <span class="ot">&lt;-</span> pres_dat_grain2</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`
`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.
Joining with `by = join_by(cell_grouping, cell_label)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind list to dataframe</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pres_dat_full <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(pres_dat_full_atlas, <span class="at">fill=</span>T)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>pres_dat_full[pres_dat_full <span class="sc">==</span> <span class="st">"&lt;NA&gt;"</span>] <span class="ot">=</span> <span class="cn">NA</span> <span class="co">#Fix NA issues in the data (takes a while.)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Column for grain size (in km, i.e., approx. length of the cell in the grid)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>pres_dat_final <span class="ot">&lt;-</span> pres_dat_full <span class="sc">%&gt;%</span>  </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cell_grouping =</span> <span class="fu">factor</span>(cell_grouping,<span class="at">levels =</span> desired_levels),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">grain =</span> <span class="fu">case_when</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>          dataset <span class="sc">==</span> atlas_names[<span class="dv">1</span>] <span class="sc">~</span> <span class="st">"10"</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>          dataset <span class="sc">==</span> atlas_names[<span class="dv">2</span>] <span class="sc">~</span> <span class="st">"5"</span>,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>          dataset <span class="sc">==</span> atlas_names[<span class="dv">3</span>] <span class="sc">~</span> <span class="st">"20"</span>, </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>          dataset <span class="sc">==</span> atlas_names[<span class="dv">4</span>] <span class="sc">~</span> <span class="st">"50"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(verbatim_name))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(pres_dat_full_atlas, pres_dat_full_grain, pres_dat_grain2, pres_dat_full, pres_data_1atlas, pres_data_full_1atlas, </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>map_atlas_1scale, atlas_1scale,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>Total_Ncells_samp, presence_data_filt, atlas, atlas_name, grain, grain_a, grain_d, n_atlas)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-occupancy" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="calculate-occupancy"><span class="header-section-number">4.1.2</span> 1.2 Calculate Occupancy</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>occ_data <span class="ot">&lt;-</span> pres_dat_final <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(dataset, tp, cell_grouping, verbatim_name, cell_label, <span class="at">.keep_all=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dataset, tp, cell_grouping, verbatim_name) <span class="sc">%&gt;%</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate AOO:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_area =</span> <span class="fu">mean</span>(area),</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">AOO =</span> <span class="fu">sum</span>(area),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">occ_Ncells =</span> <span class="fu">n_distinct</span>(cell_label)) <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate relative Occupancy:</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">rel_AOO =</span> AOO<span class="sc">/</span>Total_area_samp,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">rel_occ_Ncells =</span> occ_Ncells<span class="sc">/</span>Total_Ncells_samp) <span class="sc">%&gt;%</span> </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(dataset, tp, cell_grouping) <span class="sc">%&gt;%</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gamma =</span> <span class="fu">n_distinct</span>(verbatim_name)) <span class="sc">%&gt;%</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicated rows:</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() </span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co"># create scale column as a fraction of the full country:</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>occ_data_final <span class="ot">&lt;-</span> occ_data <span class="sc">%&gt;%</span> </span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dataset) <span class="sc">%&gt;%</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"1"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">64</span>, <span class="cn">NA</span>),</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"2"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">32</span>, scale), </span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"4"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">16</span>, scale), </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"8"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>, scale),</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"16"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, scale),</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"32"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, scale),</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">1</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"64"</span>, <span class="dv">1</span>, scale),</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"1"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">128</span>, scale),</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"2"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">16</span>, scale),</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"4"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">32</span>, scale),</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"8"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">16</span>, scale),</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"16"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>, scale),</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"32"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, scale),</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"64"</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, scale),</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">ifelse</span>(dataset <span class="sc">%in%</span> <span class="fu">c</span>(atlas_names[<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]) <span class="sc">&amp;</span> cell_grouping <span class="sc">==</span> <span class="st">"128"</span>, <span class="dv">1</span>, scale))</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(occ_data_final))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    cell_grouping        cell_label              area         cell_long 
                0                 0                 0                 0 
         cell_lat        Total_area      Total_Ncells   Total_area_samp 
                0                 0                 0                 0 
Total_Ncells_samp           dataset                tp     verbatim_name 
                0                 0                 0                 0 
            grain         mean_area               AOO        occ_Ncells 
                0                 0                 0                 0 
          rel_AOO    rel_occ_Ncells             Gamma             scale 
                0                 0                 0                 0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save reduced version of this to file:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>species_data <span class="ot">&lt;-</span> occ_data_final <span class="sc">%&gt;%</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  dataset, tp, cell_grouping, verbatim_name, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  mean_area, Total_area, Total_area_samp, Total_Ncells, Total_Ncells_samp, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  Gamma,AOO, occ_Ncells, rel_occ_Ncells, rel_AOO) <span class="sc">%&gt;%</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(dataset, tp, cell_grouping, verbatim_name, <span class="at">.keep_all =</span> T) </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(occ_data, pres_dat_final)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="occupancy-area-relationship-oar" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="occupancy-area-relationship-oar"><span class="header-section-number">4.2</span> 2. Occupancy-Area-Relationship (OAR)</h2>
<section id="mark-saturated-scales" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="mark-saturated-scales"><span class="header-section-number">4.2.1</span> 2.1 Mark saturated scales</h3>
<ul>
<li>code dummy column “exclude” to exclude species with &lt; 2 scales not saturated (i.e, if less than two scales are available for OAR calculation)</li>
<li>Saturation: rel_AOO = 1</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>list_sp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>list_tp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>list_a <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">seq_along</span>(atlas_names)){</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  temp_df <span class="ot">&lt;-</span> species_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dataset <span class="sc">==</span> atlas_names[a])</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="fu">seq_along</span>(time_periods)) {</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    temp_df_t <span class="ot">&lt;-</span> temp_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tp <span class="sc">==</span> time_periods[t])</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    species_names <span class="ot">&lt;-</span> <span class="fu">unique</span>(temp_df_t<span class="sc">$</span>verbatim_name)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">seq_along</span>(species_names)){</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      temp_df_s <span class="ot">&lt;-</span> temp_df_t <span class="sc">%&gt;%</span> <span class="fu">filter</span>(verbatim_name <span class="sc">==</span> species_names[s])</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Exclude saturated scales</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      temp_df_red <span class="ot">&lt;-</span> temp_df_s <span class="sc">%&gt;%</span> <span class="fu">filter</span>(rel_AOO <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(temp_df_red) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">nrow</span>(temp_df_red) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        out_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">verbatim_name =</span> species_names[s],</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>                             <span class="at">dataset =</span> atlas_names[a],</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>                             <span class="at">tp =</span> time_periods[t],</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>                             <span class="at">exclude =</span> <span class="dv">1</span>,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>                             <span class="at">available_scales =</span> <span class="fu">nrow</span>(temp_df_red),</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mean_relAOO =</span> <span class="fu">mean</span>(temp_df_red<span class="sc">$</span>rel_AOO, <span class="at">na.rm=</span>T))</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(temp_df_red) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        out_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">verbatim_name =</span> species_names[s],</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>                             <span class="at">dataset =</span> atlas_names[a],</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>                             <span class="at">tp =</span> time_periods[t],</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>                             <span class="at">exclude =</span> <span class="dv">0</span>,</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>                             <span class="at">available_scales =</span> <span class="fu">nrow</span>(temp_df_red),</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mean_relAOO =</span> <span class="fu">mean</span>(temp_df_red<span class="sc">$</span>rel_AOO, <span class="at">na.rm=</span>T))</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>                out_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">verbatim_name =</span> species_names[s],</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>                             <span class="at">dataset =</span> atlas_names[a],</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>                             <span class="at">tp =</span> time_periods[t],</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                             <span class="at">exclude =</span> <span class="dv">1</span>,</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>                             <span class="at">available_scales =</span> <span class="fu">nrow</span>(temp_df_red),</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mean_relAOO =</span> <span class="dv">1</span>)</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>      list_sp[[s]] <span class="ot">&lt;-</span> out_df</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    sp_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(list_sp)</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    list_tp[[t]] <span class="ot">&lt;-</span> sp_df</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>  tp_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(list_tp)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  list_a[[a]] <span class="ot">&lt;-</span> tp_df</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>atlas_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(list_a)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(atlas_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   2354 obs. of  6 variables:
 $ verbatim_name   : chr  "Accipiter gentilis" "Accipiter nisus" "Acrocephalus palustris" "Acrocephalus scirpaceus" ...
 $ dataset         : chr  "Birds_Atlas_Czechia" "Birds_Atlas_Czechia" "Birds_Atlas_Czechia" "Birds_Atlas_Czechia" ...
 $ tp              : num  1 1 1 1 1 1 1 1 1 1 ...
 $ exclude         : num  0 0 0 0 0 1 0 0 0 0 ...
 $ available_scales: int  3 3 3 4 3 1 4 2 3 3 ...
 $ mean_relAOO     : num  0.97 0.967 0.946 0.884 0.962 ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(species_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gropd_df [17,968 × 14] (S3: grouped_df/tbl_df/tbl/data.frame)
 $ dataset          : chr [1:17968] "Birds_Atlas_Czechia" "Birds_Atlas_Czechia" "Birds_Atlas_Czechia" "Birds_Atlas_Czechia" ...
 $ tp               : num [1:17968] 1 2 1 2 2 1 2 1 2 1 ...
 $ cell_grouping    : Factor w/ 8 levels "1","2","4","8",..: 1 1 1 1 1 1 1 1 1 1 ...
 $ verbatim_name    : chr [1:17968] "Accipiter gentilis" "Accipiter gentilis" "Accipiter nisus" "Accipiter nisus" ...
 $ mean_area        : num [1:17968] 134 134 134 134 134 ...
 $ Total_area       : num [1:17968] 90569 90569 90569 90569 90569 ...
 $ Total_area_samp  : num [1:17968] 83908 83908 83908 83908 83908 ...
 $ Total_Ncells     : int [1:17968] 678 678 678 678 678 678 678 678 678 678 ...
 $ Total_Ncells_samp: int [1:17968] 628 628 628 628 628 628 628 628 628 628 ...
 $ Gamma            : int [1:17968] 200 200 200 200 200 200 200 200 200 200 ...
 $ AOO              : num [1:17968] 77122 75241 76443 80030 33714 ...
 $ occ_Ncells       : int [1:17968] 577 563 572 599 252 542 576 434 452 570 ...
 $ rel_occ_Ncells   : num [1:17968] 0.919 0.896 0.911 0.954 0.401 ...
 $ rel_AOO          : num [1:17968] 0.919 0.897 0.911 0.954 0.402 ...
 - attr(*, "groups")= tibble [4 × 2] (S3: tbl_df/tbl/data.frame)
  ..$ dataset: chr [1:4] "Birds_Atlas_Czechia" "Birds_Atlas_New_York" "Birds_atlas_EBBA" "Birds_atlas_Japan"
  ..$ .rows  : list&lt;int&gt; [1:4] 
  .. ..$ : int [1:2800] 1 2 3 4 5 6 7 8 9 10 ...
  .. ..$ : int [1:3792] 2801 2802 2803 2804 2805 2806 2807 2808 2809 2810 ...
  .. ..$ : int [1:8048] 9921 9922 9923 9924 9925 9926 9927 9928 9929 9930 ...
  .. ..$ : int [1:3328] 6593 6594 6595 6596 6597 6598 6599 6600 6601 6602 ...
  .. ..@ ptype: int(0) 
  ..- attr(*, ".drop")= logi TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>sp_data_new <span class="ot">&lt;-</span> <span class="fu">full_join</span>(species_data, atlas_df) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(dataset, tp, cell_grouping, verbatim_name, <span class="at">.keep_all=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(dataset, tp, verbatim_name)`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in full_join(species_data, atlas_df): Detected an unexpected many-to-many relationship between `x` and `y`.
ℹ Row 3216 of `x` matches multiple rows in `y`.
ℹ Row 1 of `y` matches multiple rows in `x`.
ℹ If a many-to-many relationship is expected, set `relationship =
  "many-to-many"` to silence this warning.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(a,t,s, temp_df, temp_df_red, temp_df_s, temp_df_t, atlas_df, species_data, sp_df, tp_df, list_a, list_sp, list_tp, out_df)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-oar-fractal-dimension" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="calculate-oar-fractal-dimension"><span class="header-section-number">4.2.2</span> 2.2 Calculate OAR &amp; Fractal Dimension</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">&lt;-</span> sp_data_new <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(exclude <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rel_occ_Ncells <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># exclude saturated scales</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter_at</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(<span class="fu">c</span>(</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      cell_grouping, AOO, mean_area)), </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">any_vars</span>(<span class="sc">!</span><span class="fu">is.na</span>(.)))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Variables:</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>OAR_list_sp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>OAR_list_sp_tp <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>OAR_list_sp_tp_atlas <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Loop:</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n_atlas <span class="cf">in</span> <span class="fu">seq_along</span>(atlas_names)){</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  atlas_name <span class="ot">&lt;-</span> atlas_names[n_atlas]</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  atlas <span class="ot">&lt;-</span> dd <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dataset <span class="sc">==</span> atlas_name)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (time <span class="cf">in</span> <span class="fu">seq_along</span>(time_periods)){</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    period_nr <span class="ot">&lt;-</span>  time_periods[time]</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    atlas_1time <span class="ot">&lt;-</span> atlas <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tp <span class="sc">==</span> period_nr) </span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    sp <span class="ot">&lt;-</span> <span class="fu">unique</span>(atlas_1time<span class="sc">$</span>verbatim_name)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(spec <span class="cf">in</span> <span class="fu">seq_along</span>(sp)){</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>      species <span class="ot">&lt;-</span> sp[spec]</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>      model_df <span class="ot">&lt;-</span> atlas_1time <span class="sc">%&gt;%</span> </span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(verbatim_name <span class="sc">==</span> species) <span class="sc">%&gt;%</span> </span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">distinct</span>()</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>      OAR <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(AOO) <span class="sc">~</span> <span class="fu">log</span>(mean_area), <span class="at">data =</span> model_df)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>      OAR_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">verbatim_name =</span> species,</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">dataset =</span> atlas_name,</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">tp =</span> period_nr,</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">m_AOO_a =</span> OAR<span class="sc">$</span>coefficients[<span class="dv">2</span>],</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">b_AOO_a =</span> OAR<span class="sc">$</span>coefficients[<span class="dv">1</span>])</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>      OAR_df<span class="sc">$</span>D_AOO_a <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>OAR_df<span class="sc">$</span>m_AOO_a<span class="sc">+</span><span class="dv">2</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>      OAR_df<span class="sc">$</span>dataset <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(OAR_df<span class="sc">$</span>dataset)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>      OAR_list_sp[[spec]] <span class="ot">&lt;-</span> OAR_df</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    OAR_df_sp <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(OAR_list_sp, <span class="at">fill =</span> T)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    OAR_list_sp_tp[[time]] <span class="ot">&lt;-</span> OAR_df_sp</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>  OAR_df_sp_tp <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(OAR_list_sp_tp, <span class="at">fill =</span> T)   </span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>  OAR_list_sp_tp_atlas[[n_atlas]] <span class="ot">&lt;-</span> OAR_df_sp_tp</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>OAR_final <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(OAR_list_sp_tp_atlas, <span class="at">fill =</span> T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>()</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(OAR_final))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>verbatim_name       dataset            tp       m_AOO_a       b_AOO_a 
            0             0             0             0             0 
      D_AOO_a 
            0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>species_data_new <span class="ot">&lt;-</span> <span class="fu">merge</span>(sp_data_new, </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                          OAR_final, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">by=</span><span class="fu">c</span>(<span class="fu">intersect</span>(<span class="fu">names</span>(sp_data_new), <span class="fu">names</span>(OAR_final))), <span class="at">all =</span> T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>()</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(dd, OAR_list_sp_tp_atlas, OAR_list_sp_tp, OAR_df_sp_tp, OAR_list_sp, OAR_df_sp, OAR_df, sp, atlas_1time, model_df, atlas_name, OAR_final, n_atlas, OAR, period_nr, spec, species, species_names, time )</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(species_data_new))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          dataset                tp     verbatim_name     cell_grouping 
                0                 0                 0                 0 
        mean_area        Total_area   Total_area_samp      Total_Ncells 
                0                 0                 0                 0 
Total_Ncells_samp             Gamma               AOO        occ_Ncells 
                0                 0                 0                 0 
   rel_occ_Ncells           rel_AOO           exclude  available_scales 
                0                 0                 0                 0 
      mean_relAOO           m_AOO_a           b_AOO_a           D_AOO_a 
                0               315               315               315 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>species_data_new <span class="sc">%&gt;%</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(exclude <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span>    </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(dataset, tp) <span class="sc">%&gt;%</span> </span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n_distinct</span>(verbatim_name)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'dataset'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
# Groups:   dataset [1]
  dataset                tp     n
  &lt;chr&gt;               &lt;dbl&gt; &lt;int&gt;
1 Birds_Atlas_Czechia     1    21
2 Birds_Atlas_Czechia     2    24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="telfer-index-of-relative-change" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="telfer-index-of-relative-change"><span class="header-section-number">4.3</span> 3. Telfer index of relative change</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Telfer:</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>telfer_res <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(atlas_names)){</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> occ_data_final <span class="sc">%&gt;%</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(cell_grouping <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> dataset <span class="sc">==</span> atlas_names[i]) <span class="sc">%&gt;%</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(dataset, tp, verbatim_name, cell_label) </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  telfer <span class="ot">&lt;-</span> sparta<span class="sc">::</span><span class="fu">telfer</span>(<span class="at">taxa =</span> df<span class="sc">$</span>verbatim_name,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">site =</span> df<span class="sc">$</span>cell_label,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">time_period =</span> df<span class="sc">$</span>tp,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">minSite =</span> <span class="dv">1</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>telfer<span class="sc">$</span>dataset <span class="ot">&lt;-</span> atlas_names[i]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>telfer_res[[i]] <span class="ot">&lt;-</span> telfer</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>telfer_res_df <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(telfer_res, <span class="at">fill =</span> T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(taxa, Telfer_1_2, dataset) <span class="sc">%&gt;%</span> </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">verbatim_name =</span> taxa)<span class="sc">%&gt;%</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reorder_levels</span>(dataset, <span class="at">order =</span> atlas_names)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>telfer_res_df<span class="sc">$</span>Telfer_1_2 <span class="ot">&lt;-</span> <span class="fu">round</span>(telfer_res_df<span class="sc">$</span>Telfer_1_2, <span class="dv">3</span>)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>species_data_new2 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(species_data_new, telfer_res_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(dataset, verbatim_name)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(species_data_new2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          dataset                tp     verbatim_name     cell_grouping 
                0                 0                 0                 0 
        mean_area        Total_area   Total_area_samp      Total_Ncells 
                0                 0                 0                 0 
Total_Ncells_samp             Gamma               AOO        occ_Ncells 
                0                 0                 0                 0 
   rel_occ_Ncells           rel_AOO           exclude  available_scales 
                0                 0                 0                 0 
      mean_relAOO           m_AOO_a           b_AOO_a           D_AOO_a 
                0               315               315               315 
       Telfer_1_2 
                0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(atlas, df, species_data_new, sp_data_new,telfer, telfer_res_df, i, telfer_res )</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="log-ratio-of-change-in-occupancy" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="log-ratio-of-change-in-occupancy"><span class="header-section-number">4.4</span> 4. Log Ratio of Change in Occupancy</h2>
<section id="long-to-wide-format" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="long-to-wide-format"><span class="header-section-number">4.4.1</span> 4.1 Long to wide format</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>wide_dfs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(time_periods)){</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    wide_dfs[[i]] <span class="ot">&lt;-</span> species_data_new2 <span class="sc">%&gt;%</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(cell_grouping <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">distinct</span>(dataset, tp, verbatim_name, AOO) <span class="sc">%&gt;%</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(dataset, tp, verbatim_name) <span class="sc">%&gt;%</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(tp <span class="sc">==</span> time_periods[i]) <span class="sc">%&gt;%</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setNames</span>(<span class="fu">paste0</span>(<span class="st">'tp'</span>, i, <span class="st">'_'</span>, <span class="fu">names</span>(.))) <span class="sc">%&gt;%</span> </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"tp"</span>, i, <span class="st">"_tp"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">verbatim_name =</span> <span class="fu">paste0</span>(<span class="st">"tp"</span>, i, <span class="st">"_verbatim_name"</span>),</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">dataset =</span> <span class="fu">paste0</span>(<span class="st">"tp"</span>, i, <span class="st">"_dataset"</span>))</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>sp_dat_wide <span class="ot">&lt;-</span> <span class="fu">merge</span>(wide_dfs[[<span class="dv">1</span>]], wide_dfs[[<span class="dv">2</span>]])</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">is.na</span>(sp_dat_wide))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      dataset verbatim_name       tp1_AOO       tp2_AOO 
            0             0             0             0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(wide_dfs, i)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="calculate-log-ratio-of-occupancy-change" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="calculate-log-ratio-of-occupancy-change"><span class="header-section-number">4.5</span> 4.2 Calculate Log Ratio of Occupancy Change</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate log-Ratio of AOO (Temporal change)</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>logRatio <span class="ot">&lt;-</span> sp_dat_wide <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_R2_1 =</span> <span class="fu">log</span>(tp2_AOO<span class="sc">/</span>tp1_AOO)) <span class="sc">%&gt;%</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>tp1_AOO, <span class="sc">-</span>tp2_AOO)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>big_table <span class="ot">&lt;-</span> <span class="fu">full_join</span>(species_data_new2, logRatio) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cell_grouping <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(dataset, tp, cell_grouping, verbatim_name, <span class="at">.keep_all=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.numeric, round, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(dataset, verbatim_name)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(logRatio,sp_dat_wide)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="do">### =============================================== </span><span class="al">###</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="save-output" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Save Output:</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(occ_data_final, <span class="st">"../../out/rds/SpeciesDatPerCell.rds"</span>) <span class="co"># data per cell</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(big_table, <span class="st">"../../out/predictors/BigTable.rds"</span>) <span class="co"># data per species</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save.image</span>(<span class="st">"../../out/RData/2_Atlas_Var_Calc.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>